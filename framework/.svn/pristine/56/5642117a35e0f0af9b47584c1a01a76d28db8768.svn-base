<?php

class loanControl {
    public function __construct()
    {
    }

    public function exec_disbursement_schemaOp() {
        $m = new loan_disbursement_schemeModel();
        $tasks = $m->getRows(array(
            'state' => schemaStateTypeEnum::CREATE,
            'disbursable_date' => array('<', date("Y-m-d H:i:s"))
        ));
        $ret = array(
            'succeed' => 0,
            'failed' => 0,
            'skipped' => 0
        );
        foreach ($tasks as $schema) {
            $handler = loan_handlerClass::getHandler($schema->account_handler_id);
            if ($handler) {
                $rt = $handler->disburse($schema);
                if (!$rt->STS) {
                    logger::record("exec_disbursement_schema_script", $rt->MSG . "\n" . my_json_encode($schema->toArray()));
                    $ret['failed'] += 1;
                } else {
                    $ret['succeed'] += 1;
                }
            } else {
                $ret['skipped'] += 1;
            }
        }

        return new result(true, null, $ret);
    }
}