<?php

class loanControl extends baseControl {
    public function __construct() {
        parent::__construct();
        Tpl::setLayout("empty_layout");
        Tpl::output("html_title", "User List");
        Tpl::setDir("loan");
    }
    public function clientOp(){
      Tpl::showPage("client");
    }

    /**
     * region list
     */
    public function getClientListOp($p) {
      $r = new ormReader();
      $sql = "SELECT * FROM client_member";
      if($p['member_item']){
        $sql .= " where uid = ".$p['member_item'];
      }

      if($p['member_name']){
        $name = ' alias_name like "%'.$p['member_name'].'%"';
        if($p['member_item']){
          $sql .= " and ".$name;
        }else{
          $sql .= " where ".$name;
        }
      }

      $pageNumber = intval($p['pageNumber']) ?: 1;
      $pageSize = intval($p['pageSize']) ?: 20;
      $data = $r->getPage($sql, $pageNumber, $pageSize);
      $rows = $data->rows;
      $total = $data->count;
      $pageTotal = $data->pageCount;

      return array(
          "sts" => true,
          "data" => $rows,
          "total" => $total,
          "pageNumber" => $pageNumber,
          "pageTotal" => $pageTotal,
          "pageSize" => $pageSize,
      );
      Tpl::showPage("client.list");
    }

    public function clientDetailOp(){
      $p = array_merge(array(), $_GET, $_POST);
      if ($p['uid']) {
        $r = new ormReader();
        $sql = "SELECT * FROM client_member where uid = ".$p['uid'];
        $data = $r->getRow($sql);
      }
      Tpl::output("detail", $data);
      Tpl::showPage("client.detail");
    }

    public function creditOp(){
      Tpl::showPage("credit");
    }

    public function getCreditListOp($p) {
      $r = new ormReader();
      $sql = "SELECT loan.*,client.display_name,client.alias_name,client.phone_id FROM loan_account as loan left join client_member as client on loan.obj_guid = client.obj_guid";
      if($p['item']){
        $sql .= " where loan.uid = ".$p['item'];
      }
      if($p['name']){
        $name = ' client.alias_name like "%'.$p['name'].'%"';
        if($p['item']){
          $sql .= " and ".$name;
        }else{
          $sql .= " where ".$name;
        }
      }

      $pageNumber = intval($p['pageNumber']) ?: 1;
      $pageSize = intval($p['pageSize']) ?: 20;
      $data = $r->getPage($sql, $pageNumber, $pageSize);
      $rows = $data->rows;
      $total = $data->count;
      $pageTotal = $data->pageCount;

      return array(
          "sts" => true,
          "data" => $rows,
          "total" => $total,
          "pageNumber" => $pageNumber,
          "pageTotal" => $pageTotal,
          "pageSize" => $pageSize,
      );
      Tpl::showPage("credit.list");
    }

    public function editCreditOp(){
      $p = array_merge(array(), $_GET, $_POST);
      $m_loan_account = M('loan_account');
      $rt = $m_loan_account->getCreditInfo(intval($p['uid']));
      $data = $rt->DATA;
      if (!$rt->STS) {
          showMessage($rt->MSG, getUrl('loan', 'credit', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
      }
      if($p['form_submit'] == 'ok') {
        $p['before_credit'] = $data['credit'];
        $p['obj_guid'] = $data['obj_guid'];
        $rt = $m_loan_account->editCredit($p);
        if ($rt->STS) {
            showMessage($rt->MSG, getUrl('loan', 'credit', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
        } else {
            unset($p['form_submit']);
            showMessage($rt->MSG, getUrl('user', 'editCredit', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
        }
      }else{
        $m_loan_approval = M('loan_approval');
        $approvaling = $m_loan_approval->getRow(array('obj_guid' => $data['obj_guid'],'state'=>0));//申请中
        if($approvaling){
          Tpl::output('approval_info', $approvaling);
        }
        Tpl::output('loan_info', $data);
        Tpl::showPage("credit.edit");
      }

    }

    public function contractOp(){
      Tpl::showPage("contract");
    }

    public function getContractListOp($p) {
      $r = new ormReader();
      $sql = "SELECT contract.*,account.obj_guid,account.credit,member.display_name,member.alias_name,member.phone_id,member.email FROM loan_contract as contract"
            ." inner join loan_account as account on contract.account_id = account.uid"
            ." left join client_member as member on account.obj_guid = member.obj_guid where 1 = 1 ";
      if($p['item']){
        $sql .= " and contract.uid = ".$p['item'];
      }
      if($p['name']){
        $name = ' member.alias_name like "%'.$p['name'].'%"';
        $sql .= " and ".$name;
      }
      if ($p['date']) {
        $date = ' contract.start_date > "'.$p['date'].'"';
        $sql .= " and ".$date;
      }

      $pageNumber = intval($p['pageNumber']) ?: 1;
      $pageSize = intval($p['pageSize']) ?: 20;
      $data = $r->getPage($sql, $pageNumber, $pageSize);
      $rows = $data->rows;
      $total = $data->count;
      $pageTotal = $data->pageCount;

      return array(
          "sts" => true,
          "data" => $rows,
          "total" => $total,
          "pageNumber" => $pageNumber,
          "pageTotal" => $pageTotal,
          "pageSize" => $pageSize,
      );
      Tpl::showPage("contract.list");
    }

    public function contractDetailOp(){
      $p = array_merge(array(), $_GET, $_POST);
      if ($p['uid']) {
        $r = new ormReader();
        $sql = "SELECT contract.*,account.obj_guid,account.credit,member.display_name,member.alias_name,member.phone_id,member.email FROM loan_contract as contract"
              ." inner join loan_account as account on contract.account_id = account.uid"
              ." left join client_member as member on account.obj_guid = member.obj_guid where contract.uid = ".$p['uid'];
        $data = $r->getRow($sql);
      }
      Tpl::output("detail", $data);
      Tpl::showPage("contract.detail");
    }

    public function approvalOp(){
      Tpl::showPage("approval");
    }

    public function getApprovalListOp(){
      $r = new ormReader();
      $sql1 = "select uid from (select * from loan_approval order by uid desc) loan_approval group by obj_guid";
      $ids = $r->getRows($sql1);
      $ids = array_column($ids, 'uid');
      $ids =  implode(',', $ids);
      $sql = "SELECT loan.*,client.display_name,client.alias_name,client.phone_id,"
            ." approval.before_credit,approval.current_credit,approval.operator_id,approval.operate_time,approval.create_time,approval.remark,approval.type,approval.state"
            ." FROM loan_account as loan "
            ." left join client_member as client on loan.obj_guid = client.obj_guid"
            ." inner join loan_approval as approval on client.obj_guid = approval.obj_guid where approval.uid in (".$ids.")";
      if($p['item']){
        $sql .= " where loan.uid = ".$p['item'];
      }
      if($p['name']){
        $name = ' client.alias_name like "%'.$p['name'].'%"';
        if($p['item']){
          $sql .= " and ".$name;
        }else{
          $sql .= " where ".$name;
        }
      }

      $pageNumber = intval($p['pageNumber']) ?: 1;
      $pageSize = intval($p['pageSize']) ?: 20;
      $data = $r->getPage($sql, $pageNumber, $pageSize);
      $rows = $data->rows;
      $total = $data->count;
      $pageTotal = $data->pageCount;

      return array(
          "sts" => true,
          "data" => $rows,
          "total" => $total,
          "pageNumber" => $pageNumber,
          "pageTotal" => $pageTotal,
          "pageSize" => $pageSize,
      );
      Tpl::showPage("approval.list");
    }

    public function approvalEditOp(){
      $p = array_merge(array(), $_GET, $_POST);
      $m_loan_approval = M('loan_approval');
      $data = $m_loan_approval->getRow(array('uid' => $p['uid']))->toArray();
      if (!$data) {
          showMessage($rt->MSG, getUrl('loan', 'credit', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
      }
      if($p['form_submit'] == 'ok') {
        $p['before_credit'] = $data['credit'];
        $p['obj_guid'] = $data['obj_guid'];
        $rt = $m_loan_account->editCredit($p);
        if ($rt->STS) {
            showMessage($rt->MSG, getUrl('loan', 'credit', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
        } else {
            unset($p['form_submit']);
            showMessage($rt->MSG, getUrl('user', 'editCredit', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
        }
      }else{
        Tpl::output('info', $data);
        Tpl::showPage("approval.edit");
      }
    }
}
