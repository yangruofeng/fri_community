<?php

class devControl extends baseControl
{
    public function __construct()
    {
        parent::__construct();
        Tpl::setLayout("empty_layout");
        Tpl::output("html_title", "Dev");
        Tpl::setDir("dev");
    }

    /**
     * app版本
     */
    public function appVersionOp()
    {
        Tpl::showPage("app_version");
    }

    /**
     * @param $p
     * @return array
     */
    public function getAppVersionOp($p){
        $search_text = trim($p['search_text']);
        $r = new ormReader();
        $sql = "SELECT * FROM common_app_version";
        if ($search_text) {
            $sql .= " WHERE app_name LIKE '%" . $search_text . "%' OR version LIKE '%" . $search_text . "%'";
        }
        $sql .= " ORDER BY uid DESC";
        $pageNumber = intval($p['pageNumber']) ?: 1;
        $pageSize = intval($p['pageSize']) ?: 20;
        $data = $r->getPage($sql, $pageNumber, $pageSize);
        $rows = $data->rows;
        $total = $data->count;
        $pageTotal = $data->pageCount;

        return array(
            "sts" => true,
            "data" => $rows,
            "total" => $total,
            "pageNumber" => $pageNumber,
            "pageTotal" => $pageTotal,
            "pageSize" => $pageSize,
        );
    }

    /**
     * 添加新版本
     */
    public function addVersionOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        if ($p['form_submit'] == 'ok') {
            $p['creator_id'] = $this->user_id;
            $p['creator_name'] = $this->user_name;
            $m_common_app_version = M('common_app_version');
            $rt = $m_common_app_version->addVersion($p);
            if ($rt->STS) {
                showMessage($rt->MSG, getUrl('dev', 'appVersion', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
            } else {
                unset($p['form_submit']);
                showMessage($rt->MSG, getUrl('setting', 'addVersion', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
            }
        } else {
            Tpl::showPage("app_version.add");
        }
    }

}
