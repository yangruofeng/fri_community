<?php

class userBase
{
    public $property = array();
    private $roleList;
    private $authList;
    public $cache = array();//缓存数据
    static $current_user;

    public static function Current($key)
    {
        if (self::$current_user instanceof userBase) {
            return self::$current_user;
        } else {
            $user_info = operator::getUserInfo_old($key);
            if (!$user_info) return null;
            self::$current_user = new userBase($user_info);
            return self::$current_user;
        }
    }

    public function __construct($uid, $app_code = null)
    {
        if (is_numeric($uid)) {
            $orm = M("um_user");
            $this->property = $orm->getRow($uid);
        } else {
            if ($uid instanceof ormDataRow) {
                $this->property = $uid;
            } else {
                if (is_array($uid)) {
                    $this->property = new ormDataRow($uid);
                }
            }
        }
        if (!count($this->property)) {
            throw new Exception("Invalid User Information");
        }
    }

    public function getRoleList()
    {
        if ($this->roleList) return $this->roleList;
        $r = new ormReader();
        $sql = "SELECT ur.uid,ur.role_name FROM um_user_role uur LEFT JOIN um_role ur ON uur.role_id = ur.uid WHERE uur.user_id = " . $this->property->uid;
        $arr = $r->getRows($sql);
        $this->roleList = $arr;
        return $arr ?: array();
    }

    public function getAuthList()
    {
        if (is_array($this->authList)) return $this->authList;
        $role_list = $this->roleList ?: $this->getRoleList();

        $auth_arr = array();
        $class_role = new role();
        foreach ($role_list as $role) {
            $rt_role = $class_role->getRoleInfo($role['uid']);
            $auth_arr = array_merge($auth_arr, $rt_role->DATA['allow_auth']);
        }
        $auth_arr = array_unique($auth_arr);

        //去掉受限制的
        $arr_limit = $this->getUserLimitAuthList();
        $auth_arr = array_diff($auth_arr, $arr_limit);

        //增加特殊允许的
        $arr_allow = $this->getUserAllowAuthList();
        $auth_arr = array_merge(array(), $auth_arr, $arr_allow);
        $this->authList = array_unique($auth_arr);
        return $this->authList;
    }

    public function checkAuth($auth_code)
    {
        $arr = $this->getAuthList();
        return in_array($auth_code, $arr);
    }

    public function checkRoleAuth($role_code, $auth_code)
    {
        $role = roleBase::getRole($role_code);
        $arr = $role->getAuthList();
        return in_array($auth_code, $arr);
    }


    public function checkRole($role_code)
    {
        $arr = $this->getRoleList();
        return in_array($role_code, $arr);
    }

    public function getUserLimitAuthList()
    {
        $m = M("um_special_auth");
        $arr = $m->select(array('user_id' => $this->property->uid, 'special_type' => 2));
        $arr = array_column($arr, 'auth_code');
        return $arr ?: array();
    }

    public function getUserAllowAuthList()
    {
        $m = M("um_special_auth");
        $arr = $m->select(array('user_id' => $this->property->uid, 'special_type' => 1));
        $arr = array_column($arr, 'auth_code');
        return $arr ?: array();
    }

    //获取用户基本信息
    public static function getPropertyByUserId($user_id)
    {
        $m = M("um_user");
        return $m->find(array("uid" => $user_id));
    }

}

class authBase
{
    public static function getAuthGroup($_role_code)
    {
        if (in_array($_role_code, self::getAllAuthGroup())) {
            $cls_name = "authGroup_" . $_role_code;
            $role = new $cls_name();
            $role->Code = $_role_code;
            return $role;
        } else {
            return 0;
        }
    }

    public static function getAllAuthGroup()
    {
        $arr = get_declared_classes();
        $rt = array();
        foreach ($arr as $k => $v) {
            if (startWith($v, "authGroup_")) {
                $rt[] = substr($v, strlen("authGroup_"));
            }
        }
        return $rt;
    }

}

