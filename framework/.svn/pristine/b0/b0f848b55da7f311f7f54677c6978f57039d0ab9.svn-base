<?php

class passbookWorkerClass {
    public static function disburseLoan($schemeId) {
        $scheme_model = new loan_disbursement_schemeModel();
        $scheme_info = $scheme_model->getRow($schemeId);
        if (!$scheme_info) {
            return new result(false, "Disbursement scheme $schemeId not found", null, errorCodesEnum::UNEXPECTED_DATA);
        }

        // 分两个交易执行
        $conn = ormYo::Conn();
        $conn->startTransaction();

        // 第一个是转到储蓄账户
        $ret = (new loanDisburseTradingClass($scheme_info))->execute();
        if (!$ret->STS) {
            $conn->rollback();
            return $ret;
        }

        // 第二个是从储蓄账户扣除相关费用
        $ret = (new loanDeductTradingClass($scheme_info))->execute();
        if (!$ret->STS) {
            $conn->rollback();
            return $ret;
        }

        // 都成功完成提交事务
        $conn->submitTransaction();
        return $ret;
    }


}