<?php

class settingControl extends baseControl
{
    public function __construct()
    {
        parent::__construct();
        Tpl::setLayout("empty_layout");
        Tpl::output("html_title", "Company Info");
        Tpl::setDir("setting");
    }

    /**
     * 查看公司信息
     */
    public function companyInfoOp()
    {
        $m_core_dictionary = M('core_dictionary');
        $data = $m_core_dictionary->getDictionary('company_config');
        if ($data) {
            tpl::output('company_config', my_json_decode($data['dict_value']));
        }
        Tpl::showPage("company.info");
    }

    /**
     * 修改公司信息
     */
    public function editCompanyInfoOp()
    {
        $m_core_dictionary = M('core_dictionary');
        if ($_POST['form_submit'] == 'ok') {
            $param = $_POST;
            unset($param['form_submit']);
            $rt = $m_core_dictionary->updateDictionary('company_config', my_json_encode($param));
            showMessage($rt->MSG);
        } else {
            $data = $m_core_dictionary->getDictionary('company_config');
            if ($data) {
                $company_config = my_json_decode($data['dict_value']);
                tpl::output('company_config', $company_config);
            }
            $address_id = $company_config['address_id'];
            $m_core_tree = M('core_tree');
            $region_list = $m_core_tree->getParentAndBrotherById($address_id, 'region');
            Tpl::output('region_list', $region_list);
            Tpl::showPage("company.edit");
        }
    }

    /**
     *分行
     */
    public function branchOp()
    {
        Tpl::showPage("branch");
    }

    /**
     * 获取branch列表
     * @param $p
     * @return array
     */
    public function getBranchListOp($p)
    {
        $search_text = trim($p['search_text']);
        $r = new ormReader();
        $sql = "SELECT sb.*,uu.user_code FROM site_branch sb LEFT JOIN um_user uu ON sb.manager = uu.uid ";
        if ($search_text) {
            $sql .= " WHERE sb.branch_code LIKE '%" . $search_text . "%' OR sb.branch_name LIKE '%" . $search_text . "%'";
        }
        $pageNumber = intval($p['pageNumber']) ?: 1;
        $pageSize = intval($p['pageSize']) ?: 20;
        $data = $r->getPage($sql, $pageNumber, $pageSize);
        $rows = $data->rows;
        $total = $data->count;
        $pageTotal = $data->pageCount;

        return array(
            "sts" => true,
            "data" => $rows,
            "total" => $total,
            "pageNumber" => $pageNumber,
            "pageTotal" => $pageTotal,
            "pageSize" => $pageSize,
        );
    }

    /**
     * 添加role
     */
    public function addBranchOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        if ($p['form_submit'] == 'ok') {
            $p['creator_id'] = $this->user_id;
            $p['creator_name'] = $this->user_name;
            $m_site_branch = M('site_branch');
            $rt = $m_site_branch->addBranch($p);
            if ($rt->STS) {
                showMessage($rt->MSG, getUrl('setting', 'branch', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
            } else {
                unset($p['form_submit']);
                showMessage($rt->MSG, getUrl('setting', 'addBranch', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
            }
        } else {
            $user_list = M('um_user')->select(array('user_status' => 1));
            Tpl::output('user_list', $user_list);
            Tpl::showPage("branch.add");
        }
    }

    /**
     * 编辑user
     */
    public function editBranchOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        $m_site_branch = M('site_branch');
        if ($p['form_submit'] == 'ok') {
            $rt = $m_site_branch->editBranch($p);
            if ($rt->STS) {
                showMessage($rt->MSG, getUrl('setting', 'branch', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
            } else {
                unset($p['form_submit']);
                showMessage($rt->MSG, getUrl('setting', 'editBranch', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
            }
        } else {
            $branch_info = $m_site_branch->find(array('uid' => $p['uid']));
            if (!$branch_info) {
                showMessage('Invalid Id');
            } else {
                Tpl::output('branch_info', $branch_info);
            }
            $address_id = $branch_info['address_id'];
            $m_core_tree = M('core_tree');
            $region_list = $m_core_tree->getParentAndBrotherById($address_id, 'region');
            Tpl::output('region_list', $region_list);
            $user_list = M('um_user')->select(array('user_status' => 1));
            Tpl::output('user_list', $user_list);
            Tpl::showPage("branch.edit");
        }
    }

    /**
     * 删除branch
     */
    public function deleteBranchOp()
    {
        $uid = intval($_GET['uid']);
        $m_site_branch = M('site_branch');
        $rt = $m_site_branch->deleteBranch($uid);
        showMessage($rt->MSG);
    }

    /**
     * 获取地址选项
     * @param $p
     * @return array
     */
    public function getAreaListOp($p)
    {
        $pid = intval($p['uid']);
        $m_core_tree = M('core_tree');
        $list = $m_core_tree->getChildByPid($pid, 'region');
        return array('list' => $list);
    }

    /**
     * 部门列表
     */
    public function departmentOp()
    {
        Tpl::showPage("department");
    }

    /**
     * 部门列表
     */
    public function getDepartmentListOp($p)
    {
        $search_text = trim($p['search_text']);
        $r = new ormReader();
        $sql = "SELECT * FROM site_depart";
        if ($search_text) {
            $sql .= " WHERE depart_code LIKE '%" . $search_text . "%' OR depart_name LIKE '%" . $search_text . "%'";
        }
        $pageNumber = intval($p['pageNumber']) ?: 1;
        $pageSize = intval($p['pageSize']) ?: 20;
        $data = $r->getPage($sql, $pageNumber, $pageSize);
        $rows = $data->rows;
        $total = $data->count;
        $pageTotal = $data->pageCount;

        return array(
            "sts" => true,
            "data" => $rows,
            "total" => $total,
            "pageNumber" => $pageNumber,
            "pageTotal" => $pageTotal,
            "pageSize" => $pageSize,
        );
    }

    /**
     * 添加部门
     */
    public function addDepartmentOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        if ($p['form_submit'] == 'ok') {
            $m_site_depart = M('site_depart');
            $rt = $m_site_depart->addDepart($p);
            if ($rt->STS) {
                showMessage($rt->MSG, getUrl('setting', 'department', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
            } else {
                unset($p['form_submit']);
                showMessage($rt->MSG, getUrl('setting', 'addDepartment', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
            }
        } else {
            Tpl::showPage("department.add");
        }
    }

    /**
     * 修改部门
     */
    public function editDepartmentOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        $m_site_depart = M('site_depart');
        if ($p['form_submit'] == 'ok') {
            $rt = $m_site_depart->editDepart($p);
            if ($rt->STS) {
                showMessage($rt->MSG, getUrl('setting', 'department', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
            } else {
                unset($p['form_submit']);
                showMessage($rt->MSG, getUrl('setting', 'addDepartment', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
            }
        } else {
            $depart_info = $m_site_depart->find(array('uid' => $p['uid']));
            if (!$depart_info) {
                showMessage('Invalid Id');
            } else {
                Tpl::output('depart_info', $depart_info);
            }
            Tpl::showPage("department.edit");
        }
    }

    /**
     * 删除部门
     */
    public function deleteDepartment()
    {
        $uid = intval($_GET['uid']);
        $m_site_depart = M('site_depart');
        $rt = $m_site_depart->deleteDepart($uid);
        showMessage($rt->MSG);
    }

    /**
     *短码
     */
    public function shotCodeOp()
    {
        Tpl::showPage("shot_code");
    }

    /**
     * 列表
     * @param $p
     * @return array
     */
    public function getShotCodeListOp($p)
    {
        $search_text = trim($p['search_text']);
        $r = new ormReader();
        $sql = "SELECT category FROM core_definition";
        if ($search_text) {
            $sql .= " WHERE category LIKE '%" . $search_text . "%'";
        }
        $sql .= ' GROUP BY category';
        $pageNumber = intval($p['pageNumber']) ?: 1;
        $pageSize = intval($p['pageSize']) ?: 20;
        $data = $r->getPage($sql, $pageNumber, $pageSize);
        $rows = $data->rows;
        $total = $data->count;
        $pageTotal = $data->pageCount;

        $category_list = array();
        if ($rows) {
            $category_arr = array_column($rows, 'category');
            $sql = "SELECT * FROM core_definition WHERE category IN ('" . implode("','", $category_arr) . "')";
            $rows = $r->getRows($sql);
            foreach ($rows as $val) {
                $category_list[$val['category']][] = $val;
            }
        }

        return array(
            "sts" => true,
            "data" => $category_list,
            "total" => $total,
            "pageNumber" => $pageNumber,
            "pageTotal" => $pageTotal,
            "pageSize" => $pageSize,
        );
    }

    /**
     * 添加短码分类
     */
    public function addShotCodeCategoryOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        if ($p['form_submit'] == 'ok') {
            $m_core_definition = M('core_definition');
            $rt = $m_core_definition->addCategory($p);
            if ($rt->STS) {
                showMessage($rt->MSG, getUrl('setting', 'shotCode', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
            } else {
                unset($p['form_submit']);
                showMessage($rt->MSG, getUrl('setting', 'addShotCodeCategory', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
            }
        } else {
            Tpl::showPage("shot_code.category.add");
        }
    }

    /**
     * 添加短码分类
     */
    public function editShotCodeCategoryOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        if ($p['form_submit'] == 'ok') {
            $m_core_definition = M('core_definition');
            $rt = $m_core_definition->editCategory($p);
            if ($rt->STS) {
                showMessage($rt->MSG, getUrl('setting', 'shotCode', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
            } else {
                unset($p['form_submit']);
                showMessage($rt->MSG, getUrl('setting', 'addShotCodeCategory', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
            }
        } else {
            Tpl::output('category', $_GET['category']);
            Tpl::showPage("shot_code.category.edit");
        }
    }

    /**
     * 删除短码
     */
    public function deleteShotCodeOp()
    {
        $category = trim($_GET['category']);
        $m_core_definition = M('core_definition');
        $rt = $m_core_definition->deleteDefinitionByCategory($category);
        showMessage($rt->MSG);
    }

    /**
     * 添加短码值
     */
    public function addShotCodeValueOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        if ($p['form_submit'] == 'ok') {
            $m_core_definition = M('core_definition');
            $rt = $m_core_definition->addDefinition($p);
            if ($rt->STS) {
                showMessage($rt->MSG, getUrl('setting', 'shotCode', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
            } else {
                unset($p['form_submit']);
                showMessage($rt->MSG, getUrl('setting', 'addShotCodeValue', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
            }
        } else {
            Tpl::output('category', $p['category']);
            Tpl::showPage("shot_code.value.add");
        }
    }

    /**
     * 添加短码值
     */
    public function editShotCodeValueOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        if ($p['form_submit'] == 'ok') {
            $m_core_definition = M('core_definition');
            $rt = $m_core_definition->editDefinition($p);
            if ($rt->STS) {
                showMessage($rt->MSG, getUrl('setting', 'shotCode', array(), false, BACK_OFFICE_SITE_URL . '/index.php'));
            } else {
                unset($p['form_submit']);
                showMessage($rt->MSG, getUrl('setting', 'addShotCodeValue', $p, false, BACK_OFFICE_SITE_URL . '/index.php'));
            }
        } else {
            $m_site_depart = M('core_definition');
            $definition = $m_site_depart->find(array('uid' => intval($p['uid'])));
            if (!$definition) {
                showMessage('Invalid Id');
            } else {
                Tpl::output('definition', $definition);
            }
            Tpl::showPage("shot_code.value.edit");
        }
    }

    /**
     * 删除ShotCodeValue
     */
    public function deleteShotCodeValueOp()
    {
        $uid = intval($_GET['uid']);
        $m_core_definition = M('core_definition');
        $rt = $m_core_definition->deleteDefinition($uid);
        showMessage($rt->MSG);
    }

    /**
     * 编码规则
     */
    public function codingRuleOp()
    {
        var_dump('Todo soon');
//        Tpl::showPage("coding_rule");
    }
}
