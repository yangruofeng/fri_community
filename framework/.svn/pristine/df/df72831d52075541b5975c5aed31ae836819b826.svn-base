<?php

/**
 * Created by PhpStorm.
 * User: Seven
 * Date: 2017/11/7
 * Time: 9:35
 */
class role
{

    /**
     * 获取role信息
     * @param $uid
     * @return result
     */
    public function getRoleInfo($uid)
    {
        $m_um_role = M('um_role');
        $m_um_role_group = M('um_role_group');
        $m_special_auth = M('um_special_auth');
        $role_info = $m_um_role->find(array('uid' => $uid));
        if (empty($role_info)) {
            return new result(false, 'Invalid Id');
        }
        $role_group = $m_um_role_group->select(array('role_id' => $uid));
        $special_auth = $m_special_auth->select(array('role_id' => $uid));
        $role_group = array_column($role_group, 'auth_group_id');
        $allow_auth = array();
        $limit_auth = array();
        foreach ($special_auth as $auth) {
            if ($auth['special_type'] == 1) {
                $allow_auth[] = $auth['auth_code'];
            }
            if ($auth['special_type'] == 2) {
                $limit_auth[] = $auth['auth_code'];
            }
        }

        $auth_select = array();
        foreach ($role_group as $key => $r) {
            $role = authBase::getAuthGroup($r);
            $auth_group_list = $role->getAuthList();
            if (in_array($r, $role_group)) {
                $auth_select = array_merge($auth_select, $auth_group_list);
            }
        }
        $auth_select = array_merge($auth_select, $allow_auth);
        $auth_select = array_unique($auth_select);
        $auth_select = array_diff($auth_select, $limit_auth);

        $role_info['role_group'] = $role_group;
        $role_info['select_auth'] = $auth_select;
        $role_info['allow_auth'] = $allow_auth;
        $role_info['limit_auth'] = $limit_auth;
        return new result(true, '', $role_info);
    }

    /**
     * 获取role列表
     * @return result
     */
    public function getRoleList()
    {
        $m_um_role = M('um_role');
        $role_list = $m_um_role->select(array('role_status' => 1));
        foreach ($role_list as $key => $role) {
            $rt = $this->getRoleInfo($role['uid']);
            $role_list[$key] = $rt->DATA;
        }
        return new result(true, '', $role_list);
    }

    /**
     * 添加role
     * @param $param
     * @return result
     */
    public function addRole($param)
    {
        $role_name = trim($param['role_name']);
        $auth_group = $param['auth_group'];
        $auth_select = $param['auth_select'];
        $remark = $param['remark'];
        $role_status = intval($param['role_status']);
        $creator_id = intval($param['creator_id']);
        $creator_name = $param['creator_name'];
        if (!$role_name) {
            return new result(false, 'Role name cannot be empty!');
        }
        $m_um_role = M('um_role');
        $m_um_role_group = M('um_role_group');
        $m_special_auth = M('um_special_auth');

        $chk_name = $m_um_role->getRow(array('role_name' => $role_name));
        if ($chk_name) {
            return new result(false, 'Name exists!');
        }

        $conn = ormYo::Conn();
        $conn->startTransaction();
        try {
            $row = $m_um_role->newRow();
            $row->role_name = $role_name;
            $row->role_status = $role_status;
            $row->role_status = $role_status;
            $row->creator_id = $creator_id;
            $row->creator_name = $creator_name;
            $row->create_time = Now();
            $row->remark = $remark;
            $rt_1 = $row->insert();
            if (!$rt_1->STS) {
                $conn->rollback();
                return new result(false, 'Add failed--' . $rt_1->MSG);
            }

            $auth_list = array();
            foreach ($auth_group as $group) {
                $row_group = $m_um_role_group->newRow();
                $row_group->role_id = $rt_1->AUTO_ID;
                $row_group->auth_group_id = $group;
                $rt_2 = $row_group->insert();
                if (!$rt_2->STS) {
                    $conn->rollback();
                    return new result(false, 'Add failed--' . $rt_2->MSG);
                }

                $role = authBase::getAuthGroup($group);
                $auth_group_list = $role->getAuthList();
                $auth_list = array_merge($auth_list, $auth_group_list);
            }
            $auth_list = array_unique($auth_list);
            $allow_auth = array_diff($auth_select, $auth_list);
            $limit_auth = array_diff($auth_list, $auth_select);

            foreach ($allow_auth as $auth) {
                $row_special_auth = $m_special_auth->newRow();
                $row_special_auth->role_id = $rt_1->AUTO_ID;
                $row_special_auth->special_type = 1;
                $row_special_auth->auth_code = $auth;
                $rt_3 = $row_special_auth->insert();
                if (!$rt_3->STS) {
                    $conn->rollback();
                    return new result(false, 'Add failed--' . $rt_3->MSG);
                }
            }

            foreach ($limit_auth as $auth) {
                $row_special_auth = $m_special_auth->newRow();
                $row_special_auth->role_id = $rt_1->AUTO_ID;
                $row_special_auth->special_type = 2;
                $row_special_auth->auth_code = $auth;
                $rt_4 = $row_special_auth->insert();
                if (!$rt_4->STS) {
                    $conn->rollback();
                    return new result(false, 'Add failed--' . $rt_4->MSG);
                }
            }

            $conn->submitTransaction();
            return new result(true, 'Add Successful');
        } catch (Exception $ex) {
            $conn->rollback();
            return new result(false, $ex->getMessage());
        }
    }

    /**
     * 编辑role
     * @param $param
     * @return result
     */
    public function editRole($param)
    {
        $uid = intval($param['uid']);
        $role_name = trim($param['role_name']);
        $auth_group = $param['auth_group'];
        $auth_select = $param['auth_select'];
        $remark = $param['remark'];
        $role_status = intval($param['role_status']);
        if (!$role_name) {
            return new result(false, 'Role name cannot be empty!');
        }
        $m_um_role = M('um_role');
        $m_um_role_group = M('um_role_group');
        $m_special_auth = M('um_special_auth');

        $row = $m_um_role->getRow(array('uid' => $uid));
        if (empty($row)) {
            return new result(false, 'Invalid Id!');
        }

        $chk_name = $m_um_role->getRow(array('role_name' => $role_name, 'uid' => array('neq', $uid)));
        if ($chk_name) {
            return new result(false, 'Name text exists!');
        }

        $conn = ormYo::Conn();
        $conn->startTransaction();
        try {
            $row->role_name = $role_name;
            $row->role_status = $role_status;
            $row->role_status = $role_status;
            $row->update_time = Now();
            $row->remark = $remark;
            $rt_1 = $row->update();
            if (!$rt_1->STS) {
                $conn->rollback();
                return new result(false, 'Edit failed--' . $rt_1->MSG);
            }

            $rt_5 = $m_um_role_group->delete(array('role_id' => $uid));
            if (!$rt_5->STS) {
                $conn->rollback();
                return new result(false, 'Edit failed--' . $rt_5->MSG);
            }

            $auth_list = array();
            foreach ($auth_group as $group) {
                $row_group = $m_um_role_group->newRow();
                $row_group->role_id = $rt_1->AUTO_ID;
                $row_group->auth_group_id = $group;
                $rt_2 = $row_group->insert();
                if (!$rt_2->STS) {
                    $conn->rollback();
                    return new result(false, 'Edit failed--' . $rt_2->MSG);
                }

                $role = authBase::getAuthGroup($group);
                $auth_group_list = $role->getAuthList();
                $auth_list = array_merge($auth_list, $auth_group_list);
            }
            $auth_list = array_unique($auth_list);
            $allow_auth = array_diff($auth_select, $auth_list);
            $limit_auth = array_diff($auth_list, $auth_select);
            $rt_6 = $m_special_auth->delete(array('role_id' => $uid));
            if (!$rt_6->STS) {
                $conn->rollback();
                return new result(false, 'Edit failed--' . $rt_6->MSG);
            }
            foreach ($allow_auth as $auth) {
                $row_special_auth = $m_special_auth->newRow();
                $row_special_auth->role_id = $uid;
                $row_special_auth->special_type = 1;
                $row_special_auth->auth_code = $auth;
                $rt_3 = $row_special_auth->insert();
                if (!$rt_3->STS) {
                    $conn->rollback();
                    return new result(false, 'Edit failed--' . $rt_3->MSG);
                }
            }

            foreach ($limit_auth as $auth) {
                $row_special_auth = $m_special_auth->newRow();
                $row_special_auth->role_id = $uid;
                $row_special_auth->special_type = 2;
                $row_special_auth->auth_code = $auth;
                $rt_4 = $row_special_auth->insert();
                if (!$rt_4->STS) {
                    $conn->rollback();
                    return new result(false, 'Edit failed--' . $rt_4->MSG);
                }
            }

            $conn->submitTransaction();
            return new result(true, 'Edit Successful');
        } catch (Exception $ex) {
            $conn->rollback();
            return new result(false, $ex->getMessage());
        }
    }

    /**
     * 删除role
     * @param $uid
     * @return result
     */
    public function deleteRole($uid)
    {
        $m_um_role = M('um_role');
        $m_um_role_group = M('um_role_group');
        $m_special_auth = M('um_special_auth');
        $m_um_user_role = M('um_user_role');

        $uid = intval($uid);
        $row = $m_um_role->getRow(array('uid' => $uid));
        if (empty($row)) {
            return new result(false, 'Invalid Id!');
        }

        $chk_used = $m_um_user_role->find(array('role_id' => $uid));
        if ($chk_used) {
            return new result(false, 'Cannot be deleted because it has been used!');
        }

        $conn = ormYo::Conn();
        $conn->startTransaction();
        try {
            $rt_1 = $row->delete();
            if (!$rt_1->STS) {
                $conn->rollback();
                return new result(false, 'Delete failed--' . $rt_1->MSG);
            }

            $rt_2 = $m_um_role_group->delete(array('role_id' => $uid));
            if (!$rt_2->STS) {
                $conn->rollback();
                return new result(false, 'Delete failed--' . $rt_2->MSG);
            }

            $rt_3 = $m_special_auth->delete(array('role_id' => $uid));
            if (!$rt_3->STS) {
                $conn->rollback();
                return new result(false, 'Delete failed--' . $rt_3->MSG);
            }

            $conn->submitTransaction();
            return new result(true, 'Delete Successful');
        } catch (Exception $ex) {
            $conn->rollback();
            return new result(false, $ex->getMessage());
        }

    }
}