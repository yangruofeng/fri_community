<?php

/**
 * Created by PhpStorm.
 * User: Seven
 * Date: 2017/10/31
 * Time: 09:30
 */
class apiLoginControl
{
    function __construct()
    {
        Language::read('entry_index,common');
    }

    /**
     * 登录api
     * @return result
     */
    function loginOp()
    {
        $p = array_merge(array(), $_GET, $_POST);
        $user_code = trim($p['user_code']);
        $user_password = trim($p['user_password']);

        if (empty($user_code)) {
            return new result(false, 'The account cannot be empty!');
        }

        if (empty($user_password)) {
            return new result(false, 'The password cannot be empty!');
        }

        $m_um_user = M('um_user');
        $user = $m_um_user->getRow(array(
            "user_code" => $user_code,
        ));

        if (empty($user)) {
            return new result(false, 'Account error!');
        }

        if ($user->user_status == 0) {
            return new result(false, 'Deactivated account!');
        }

        if (empty($user) || $user->password != md5($user_password)) {
            return new result(false, 'Password error!');
        }

        $data_update = array(
            'uid' => $user->uid,
            'last_login_time' => Now(),
            'last_login_ip' => getIp()
        );
        $m_um_user->update($data_update);
        $user_arr = $user->toArray();

        setSessionVar("user_info", $user_arr);
        setSessionVar("is_login", "ok");

        $m_um_user_log = M('um_user_log');
        $m_um_user_log->recordLogin($user->uid, 'web');

        if ($p["remember_me"] == 1) {
            setcookie("user_code", $p["user_code"], time() + 3600 * 24 * 7);
        } else {
            setcookie("user_code", "", time() - 3600);
        }

        return new result(true, '', array('new_url' => ENTRY_DESKTOP_SITE_URL . DS . 'index.php'));
    }

}
